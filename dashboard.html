<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Setup</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
html,body{height:100%;width:100%;overflow:hidden;}

body{
  display:flex;
  justify-content:center;
  align-items:center;
  background:url('assets/src/authbg.jpg') center/cover no-repeat;
  position:relative;
}
body::before{
  content:"";
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.65);
}

/* WRAPPER */
.wrapper{
  position:relative;
  z-index:2;
  width:92%;
  max-width:900px;
  height:92vh;
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* HEADER */
.header{text-align:center;}
.header h1{color:#f7a800;font-size:1.4rem;font-weight:600;}
.header p{color:#ccc;font-size:0.9rem;}

/* GRID */
.grid{
  flex:1;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

/* CARD */
.card{
  background:rgba(255,255,255,0.06);
  border-radius:14px;
  padding:12px;
  border:1px solid rgba(255,255,255,0.15);
  display:flex;
  flex-direction:column;
  gap:8px;
}
.card h3{color:#f7a800;font-size:0.95rem;font-weight:500;}

/* INPUTS */
input,textarea{
  padding:8px 10px;
  border:none;
  border-radius:6px;
  background:rgba(255,255,255,0.12);
  color:#fff;
  font-size:0.85rem;
}
textarea{resize:none;height:65px;}
input::placeholder,textarea::placeholder{color:#ccc;}

/* LOGO */
.logo-box{
  height:75px;
  border:2px dashed #f7a800;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#ccc;
  font-size:0.8rem;
  cursor:pointer;
  overflow:hidden;
}
.logo-box img{max-width:100%;max-height:100%;object-fit:contain;}
.logo-msg{text-align:center;font-size:0.75rem;color:#f7a800;}

/* SOCIAL */
.social{display:grid;grid-template-columns:1fr 1fr;gap:6px;}

/* BUTTON */
.footer{display:flex;justify-content:center;}
button{
  width:180px;
  padding:10px;
  border:none;
  border-radius:10px;
  background:linear-gradient(135deg,#f7a800,#ffba00);
  font-weight:500;
  cursor:pointer;
  transition:0.2s;
}
button:disabled{opacity:0.7;cursor:not-allowed;}
button:hover{transform:translateY(-1px);}

/* SUCCESS */
.success{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:99;
  opacity:0;
  pointer-events:none;
  transition:0.4s;
}
.success.show{opacity:1;pointer-events:auto;}
.success-box{
  background:#111;
  padding:32px 44px;
  border-radius:18px;
  text-align:center;
  color:#fff;
  border:1px solid #f7a800;
  animation:pop .45s ease forwards;
}
@keyframes pop{to{transform:scale(1);}}
</style>
</head>

<body>

<div class="wrapper">

  <div class="header">
    <h1>Jaza maelezo muhimu ya kampuni yako</h1>
    <p>Maelezo haya yataonekana kwenye profile yako</p>
  </div>

  <div class="grid">

    <div class="card">
      <h3>Company Info</h3>
      <input id="companyName" placeholder="Company / Studio Name">

      <div class="logo-box" id="logoBox">Weka logo yako hapa</div>
      <input type="file" id="logo" hidden>
      <div class="logo-msg" id="logoMsg"></div>

      <input id="slogan" placeholder="Slogan / Tagline">
    </div>

    <div class="card">
      <h3>Contact Details</h3>
      <input id="companyEmail" type="email" placeholder="Company Email">
      <input id="phone" placeholder="Phone / WhatsApp">
      <input id="address" placeholder="City / Address">
    </div>

    <div class="card">
      <h3>About Company</h3>
      <textarea id="description" placeholder="Brief description about your services"></textarea>
    </div>

    <div class="card">
      <h3>Social Links</h3>
      <div class="social">
        <input id="instagram" placeholder="Instagram">
        <input id="facebook" placeholder="Facebook">
        <input id="tiktok" placeholder="TikTok">
        <input id="linkedin" placeholder="LinkedIn">
      </div>
    </div>

  </div>

  <div class="footer">
    <button id="saveProfile">Save Profile</button>
  </div>
</div>

<div class="success" id="success">
  <div class="success-box">
    <h2>Profile Saved Successfully</h2>
    <p>Redirecting...</p>
  </div>
</div>

<script type="module">
import { auth, db, storage } from "./firebase.js";
import { setDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ================== AUTHENTICATION ================== */
let currentUser = null;
onAuthStateChanged(auth, user => {
  if (!user) {
    location.replace("login.html");
    return;
  }
  currentUser = user;
});

/* ================== LOGO UPLOAD ================== */
let logoFile = null;
const logoBox = document.getElementById("logoBox");
const logo = document.getElementById("logo");
const logoMsg = document.getElementById("logoMsg");

logoBox.addEventListener("click", () => logo.click());
logo.addEventListener("change", () => {
  logoFile = logo.files[0];
  if (!logoFile) return;

  const reader = new FileReader();
  reader.onload = e => {
    logoBox.innerHTML = `<img src="${e.target.result}">`;
    logoMsg.textContent = "Logo uploaded successfully";
  };
  reader.readAsDataURL(logoFile);
});

/* ================== SAVE PROFILE ================== */
const saveProfile = document.getElementById("saveProfile");
const success = document.getElementById("success");

// Input references
const companyName = document.getElementById("companyName");
const slogan = document.getElementById("slogan");
const companyEmail = document.getElementById("companyEmail");
const phone = document.getElementById("phone");
const address = document.getElementById("address");
const description = document.getElementById("description");
const instagram = document.getElementById("instagram");
const facebook = document.getElementById("facebook");
const tiktok = document.getElementById("tiktok");
const linkedin = document.getElementById("linkedin");

saveProfile.addEventListener("click", async () => {
  if (!currentUser) return;

  // Basic validation
  if (!companyName.value.trim() || !companyEmail.value.trim()) {
    alert("Tafadhali jaza jina la kampuni na email");
    return;
  }

  // Disable inputs + button
  [companyName, slogan, companyEmail, phone, address, description,
   instagram, facebook, tiktok, linkedin, logo].forEach(el => el.disabled = true);
  saveProfile.disabled = true;
  saveProfile.textContent = "Saving...";

  let logoURL = "";
  if (logoFile) {
    try {
      const storageRef = ref(storage, `photographers/${currentUser.uid}/logo.png`);
      await uploadBytes(storageRef, logoFile);
      logoURL = await getDownloadURL(storageRef);
    } catch (err) {
      console.error("Logo upload failed:", err);
      alert("Logo upload failed. Please try again.");
    }
  }

  try {
    await setDoc(doc(db, "photographers", currentUser.uid), {
      companyName: companyName.value.trim(),
      slogan: slogan.value.trim(),
      companyEmail: companyEmail.value.trim(),
      phone: phone.value.trim(),
      address: address.value.trim(),
      description: description.value.trim(),
      instagram: instagram.value.trim(),
      facebook: facebook.value.trim(),
      tiktok: tiktok.value.trim(),
      linkedin: linkedin.value.trim(),
      logoURL,
      uid: currentUser.uid,
      updatedAt: new Date()
    }, { merge: true });

    success.classList.add("show");

    setTimeout(() => {
      location.replace("index.html");
    }, 2000);

  } catch (err) {
    console.error("Error saving profile:", err);
    alert("Something went wrong while saving. Please try again.");
    // Re-enable inputs + button
    [companyName, slogan, companyEmail, phone, address, description,
     instagram, facebook, tiktok, linkedin, logo].forEach(el => el.disabled = false);
    saveProfile.disabled = false;
    saveProfile.textContent = "Save Profile";
  }
});
</script>

</body>
</html>

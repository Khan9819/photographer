<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Pixiest</title>
    <style>
        body { font-family: 'Roboto', sans-serif; background: #0a0a0a; color: #fff; padding: 20px; }
        .dashboard-card { 
            background: #141414; padding: 20px; border-radius: 15px; 
            max-width: 500px; margin: auto; text-align: center; border: 1px solid #f7a800;
        }
        .profile-img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #f7a800; }
        .btn-danger { background: #ff4d4d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 20px; }
        .btn-logout { background: #555; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="dashboard-card">
        <img id="homeLogo" src="assets/src/default-avatar.png" alt="Logo" class="profile-img">
        <h2 id="homeName">Loading...</h2>
        <p id="homeSpecialization" style="color: #f7a800;"></p>
        <p id="homeBio" style="font-size: 14px; color: #ccc;"></p>
        <hr style="border: 0.5px solid #333; margin: 20px 0;">
        
        <button class="btn-logout" id="logoutBtn">Logout</button>
        <button class="btn-danger" id="deleteBtn">Futa Akaunti</button>
    </div>

    <script type="module">
        import { auth, db } from "./firebase.js";
        import { onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. Kagua hali ya mtumiaji
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Ikiwa hayupo (ka-logout au kafutwa), mpeleke SIGNUP
                window.location.href = "signup.html";
                return;
            }

            try {
                // 2. Vuta Data za Mpigapicha
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Jaza taarifa kwenye HTML
                    document.getElementById("homeName").textContent = data.brandName || data.displayName || "Mpigapicha";
                    document.getElementById("homeSpecialization").textContent = data.specialization || "Bado haijawekwa";
                    document.getElementById("homeBio").textContent = data.bio || "Karibu kwenye profile yangu.";
                    
                    if (data.logoURL) {
                        document.getElementById("homeLogo").src = data.logoURL;
                    }
                } else {
                    // Ikiwa akaunti ipo Auth lakini haina data Firestore, mpeleke akajaze
                    window.location.href = "photographerdata.html";
                }
            } catch (error) {
                console.error("Kosa la kupata data:", error);
            }
        });

        // 3. Logout
        document.getElementById("logoutBtn").onclick = async () => {
            await signOut(auth);
            window.location.href = "signup.html";
        };

        // 4. Futa Akaunti (Delete Account)
        document.getElementById("deleteBtn").onclick = async () => {
            const user = auth.currentUser;
            if (confirm("Je, una uhakika unataka kufuta akaunti? Data zako zote zitapotea.")) {
                try {
                    // Futa data Firestore kwanza
                    await deleteDoc(doc(db, "users", user.uid));
                    
                    // Futa mtumiaji kwenye Authentication
                    await deleteUser(user);
                    
                    alert("Akaunti imefutwa.");
                    window.location.href = "signup.html";
                } catch (error) {
                    console.error(error);
                    alert("Tafadhali Logout kisha uingie tena (Re-authenticate) ili uweze kufuta akaunti kwa usalama.");
                }
            }
        };
    </script>
</body>
</html>